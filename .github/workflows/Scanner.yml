name: TruffleHog Secret Scan

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  secret-scan:
    name: Run TruffleHog on PR Changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history

      - name: Get changed files
        id: changed-files
        run: |
          BASE_BRANCH=${{ github.base_ref }}
          git fetch origin $BASE_BRANCH --depth=1
          git diff --name-only origin/$BASE_BRANCH HEAD > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt

      - name: Install TruffleHog v3
        run: |
          curl -L https://github.com/trufflesecurity/trufflehog/releases/latest/download/trufflehog-linux-amd64 -o trufflehog
          chmod +x trufflehog
          sudo mv trufflehog /usr/local/bin/

      - name: Run TruffleHog on changed files
        id: trufflehog-scan
        run: |
          if [ -s changed_files.txt ]; then
            while read -r file; do
              echo "Scanning $file for secrets..."
              trufflehog filesystem --no-verification --json "$file" || exit 1
            done < changed_files.txt
          else
            echo "No changed files to scan."
          fi

      - name: Fail workflow if secrets are found
        if: failure()
        run: exit 1
