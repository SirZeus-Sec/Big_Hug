name: TruffleHog Secret Scan

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  secret-scan:
    name: Run TruffleHog on PR Changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Fetch only latest changes

      - name: Get changed files
        id: changed-files
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1
          git diff --name-only origin/${{ github.base_ref }} ${{ github.event.pull_request.head.sha }} > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt

      - name: Install TruffleHog
        run: pip install trufflehog

      - name: Run TruffleHog on changed files
        id: trufflehog-scan
        run: |
          if [ -s changed_files.txt ]; then
            while read -r file; do
              echo "Scanning $file for secrets..."
              trufflehog --regex --entropy=True "$file" || exit 1
            done < changed_files.txt
          else
            echo "No changed files to scan."
          fi

      - name: Fail workflow if secrets are found
        if: failure()
        run: exit 1
